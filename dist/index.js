import g from"fs";import o from"path";import{removeBackground as C}from"@imgly/background-removal-node";import D from"sharp";import u from"ora";import{exec as B,spawn as x}from"child_process";import{promisify as O}from"util";import h from"path";var F=O(B);async function P(){try{return await F("ffmpeg -version"),!0}catch{return!1}}async function l(e){let{stdout:n}=await F(`ffprobe -v quiet -print_format json -show_streams -show_format "${e}"`),r=JSON.parse(n),t=r.streams.find(c=>c.codec_type==="video");if(!t)throw new Error("No video stream found");let a=30;if(t.r_frame_rate){let[c,m]=t.r_frame_rate.split("/").map(Number);a=m?c/m:c}let s=parseFloat(r.format?.duration||"0"),i=Math.ceil(a*s);return{width:t.width,height:t.height,fps:a,frames:i,duration:s}}async function $(e,n){return new Promise((r,t)=>{let a=h.join(n,"frame_%06d.png"),s=x("ffmpeg",["-i",e,"-vsync","0",a]);s.on("close",i=>{i===0?r():t(new Error(`FFmpeg exited with code ${i}`))}),s.on("error",t)})}async function S(e,n,r,t){return new Promise((a,s)=>{let i=h.join(e,"frame_%06d.png"),c;switch(t){case"webm":c=["-y","-framerate",r.toString(),"-i",i,"-c:v","libvpx-vp9","-pix_fmt","yuva420p","-auto-alt-ref","0","-b:v","2M","-crf","30",n];break;case"mov":c=["-y","-framerate",r.toString(),"-i",i,"-c:v","prores_ks","-profile:v","4444","-pix_fmt","yuva444p10le",n];break;case"gif":c=["-y","-framerate",r.toString(),"-i",i,"-filter_complex","[0:v] split [a][b];[a] palettegen=reserve_transparent=on:transparency_color=ffffff [p];[b][p] paletteuse",n];break}let m=x("ffmpeg",c);m.on("close",f=>{f===0?a():s(new Error(`FFmpeg exited with code ${f}`))}),m.on("error",s)})}var M=new Set([".mp4",".mov",".webm",".avi",".mkv",".m4v",".ogv"]),q=new Set([".jpg",".jpeg",".png",".webp",".bmp",".tiff"]);function _(e){return M.has(o.extname(e).toLowerCase())}function k(e){return q.has(o.extname(e).toLowerCase())}function A(e){return g.statSync(e).isFile()?[e]:g.readdirSync(e).map(r=>o.join(e,r)).filter(r=>g.statSync(r).isFile()&&(_(r)||k(r)))}async function I(e,n){let r=`file://${e}`,a=await(await C(r)).arrayBuffer(),s=Buffer.from(a),i=n.replace(/\.[^.]+$/,".png");await D(s).png().toFile(i)}async function L(e,n){let r=o.basename(e,o.extname(e)),t=o.join(n,`${r}_cutout.png`),a=u(`Processing: ${o.basename(e)}`).start();try{await I(e,t),a.succeed(`Done: ${o.basename(t)}`)}catch(s){throw a.fail(`Failed: ${o.basename(e)}`),s}}async function R(e,n,r){let t=o.basename(e,o.extname(e)),a=r.format==="mov"?".mov":r.format==="gif"?".gif":".webm",s=o.join(n,`${t}_cutout${a}`);console.log(`
\u{1F4F9} Processing: ${o.basename(e)}`);let i=o.join(n,".tmp",t),c=o.join(i,"raw"),m=o.join(i,"transparent");g.mkdirSync(c,{recursive:!0}),g.mkdirSync(m,{recursive:!0});try{let f=await l(e);console.log(`   ${f.width}x${f.height}, ${f.fps.toFixed(2)}fps, ${f.frames} frames`);let E=u("Extracting frames...").start();await $(e,c),E.succeed("Frames extracted");let d=g.readdirSync(c).filter(p=>p.endsWith(".png")).sort(),v=u(`Removing backgrounds (0/${d.length})`).start();for(let p=0;p<d.length;p++){let w=d[p],V=o.join(c,w),N=o.join(m,w);await I(V,N),v.text=`Removing backgrounds (${p+1}/${d.length})`}v.succeed("Backgrounds removed");let j=u("Creating video...").start();await S(m,s,f.fps,r.format),j.succeed(`Created: ${o.basename(s)}`)}finally{g.rmSync(i,{recursive:!0,force:!0})}}async function T(e,n,r){let t=A(e);if(t.length===0)throw new Error(`No supported files found in: ${e}`);let a=t.filter(k),s=t.filter(_);console.log(`\u{1F4C1} Found: ${a.length} image(s), ${s.length} video(s)`);for(let i of a)await L(i,n);for(let i of s)await R(i,n,r)}export{P as checkFfmpeg,l as getVideoInfo,T as processFiles};
