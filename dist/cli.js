#!/usr/bin/env node
import{program as N}from"commander";import p from"fs";import s from"path";import{removeBackground as M}from"@imgly/background-removal-node";import R from"sharp";import d from"ora";import{exec as D,spawn as x}from"child_process";import{promisify as L}from"util";import F from"path";var $=L(D);async function S(){try{return await $("ffmpeg -version"),!0}catch{return!1}}async function _(e){let{stdout:t}=await $(`ffprobe -v quiet -print_format json -show_streams -show_format "${e}"`),o=JSON.parse(t),r=o.streams.find(m=>m.codec_type==="video");if(!r)throw new Error("No video stream found");let n=30;if(r.r_frame_rate){let[m,c]=r.r_frame_rate.split("/").map(Number);n=c?m/c:m}let i=parseFloat(o.format?.duration||"0"),a=Math.ceil(n*i);return{width:r.width,height:r.height,fps:n,frames:a,duration:i}}async function I(e,t){return new Promise((o,r)=>{let n=F.join(t,"frame_%06d.png"),i=x("ffmpeg",["-i",e,"-vsync","0",n]);i.on("close",a=>{a===0?o():r(new Error(`FFmpeg exited with code ${a}`))}),i.on("error",r)})}async function k(e,t,o,r){return new Promise((n,i)=>{let a=F.join(e,"frame_%06d.png"),m;switch(r){case"webm":m=["-y","-framerate",o.toString(),"-i",a,"-c:v","libvpx-vp9","-pix_fmt","yuva420p","-auto-alt-ref","0","-b:v","2M","-crf","30",t];break;case"mov":m=["-y","-framerate",o.toString(),"-i",a,"-c:v","prores_ks","-profile:v","4444","-pix_fmt","yuva444p10le",t];break;case"gif":m=["-y","-framerate",o.toString(),"-i",a,"-filter_complex","[0:v] split [a][b];[a] palettegen=reserve_transparent=on:transparency_color=ffffff [p];[b][p] paletteuse",t];break}let c=x("ffmpeg",m);c.on("close",f=>{f===0?n():i(new Error(`FFmpeg exited with code ${f}`))}),c.on("error",i)})}var T=new Set([".mp4",".mov",".webm",".avi",".mkv",".m4v",".ogv"]),X=new Set([".jpg",".jpeg",".png",".webp",".bmp",".tiff"]);function E(e){return T.has(s.extname(e).toLowerCase())}function j(e){return X.has(s.extname(e).toLowerCase())}function G(e){return p.statSync(e).isFile()?[e]:p.readdirSync(e).map(o=>s.join(e,o)).filter(o=>p.statSync(o).isFile()&&(E(o)||j(o)))}async function O(e,t){let o=`file://${e}`,n=await(await M(o)).arrayBuffer(),i=Buffer.from(n),a=t.replace(/\.[^.]+$/,".png");await R(i).png().toFile(a)}async function J(e,t){let o=s.basename(e,s.extname(e)),r=s.join(t,`${o}_cutout.png`),n=d(`Processing: ${s.basename(e)}`).start();try{await O(e,r),n.succeed(`Done: ${s.basename(r)}`)}catch(i){throw n.fail(`Failed: ${s.basename(e)}`),i}}async function U(e,t,o){let r=s.basename(e,s.extname(e)),n=o.format==="mov"?".mov":o.format==="gif"?".gif":".webm",i=s.join(t,`${r}_cutout${n}`);console.log(`
\u{1F4F9} Processing: ${s.basename(e)}`);let a=s.join(t,".tmp",r),m=s.join(a,"raw"),c=s.join(a,"transparent");p.mkdirSync(m,{recursive:!0}),p.mkdirSync(c,{recursive:!0});try{let f=await _(e);console.log(`   ${f.width}x${f.height}, ${f.fps.toFixed(2)}fps, ${f.frames} frames`);let q=d("Extracting frames...").start();await I(e,m),q.succeed("Frames extracted");let l=p.readdirSync(m).filter(u=>u.endsWith(".png")).sort(),w=d(`Removing backgrounds (0/${l.length})`).start();for(let u=0;u<l.length;u++){let y=l[u],A=s.join(m,y),C=s.join(c,y);await O(A,C),w.text=`Removing backgrounds (${u+1}/${l.length})`}w.succeed("Backgrounds removed");let P=d("Creating video...").start();await k(c,i,f.fps,o.format),P.succeed(`Created: ${s.basename(i)}`)}finally{p.rmSync(a,{recursive:!0,force:!0})}}async function V(e,t,o){let r=G(e);if(r.length===0)throw new Error(`No supported files found in: ${e}`);let n=r.filter(j),i=r.filter(E);console.log(`\u{1F4C1} Found: ${n.length} image(s), ${i.length} video(s)`);for(let a of n)await J(a,t);for(let a of i)await U(a,t,o)}import B from"path";import v from"fs";N.name("human-cutout").description("AI-powered background removal for images and videos").version("1.0.0").option("-i, --input <path>","Input file or directory","./input").option("-o, --output <path>","Output directory","./output").option("-f, --format <format>","Video output format (webm, mov, gif)","webm").option("-q, --quality <quality>","Output quality (low, medium, high)","medium").parse();var g=N.opts();async function W(){console.log(`
\u{1F3AC} human-cutout - AI Background Removal
`),await S()||(console.error("\u274C FFmpeg is required but not found."),console.error("   Install: brew install ffmpeg (macOS) or apt install ffmpeg (Linux)"),process.exit(1));let t=B.resolve(g.input),o=B.resolve(g.output);v.existsSync(t)||(console.error(`\u274C Input not found: ${t}`),process.exit(1)),v.existsSync(o)||v.mkdirSync(o,{recursive:!0});let r=["webm","mov","gif"];r.includes(g.format)||(console.error(`\u274C Invalid format: ${g.format}`),console.error(`   Valid formats: ${r.join(", ")}`),process.exit(1));try{await V(t,o,{format:g.format,quality:g.quality}),console.log(`
\u2705 Done! Output: ${o}
`)}catch(n){console.error(`
\u274C Error:`,n),process.exit(1)}}W();
