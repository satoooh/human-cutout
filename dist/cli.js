#!/usr/bin/env node
import{program as B}from"commander";import p from"fs";import n from"path";import{createRequire as L}from"module";import{removeBackground as M}from"@imgly/background-removal-node";import T from"sharp";import d from"ora";import{exec as C,spawn as x}from"child_process";import{promisify as D}from"util";import F from"path";var $=D(C);async function S(){try{return await $("ffmpeg -version"),!0}catch{return!1}}async function _(e){let{stdout:t}=await $(`ffprobe -v quiet -print_format json -show_streams -show_format "${e}"`),o=JSON.parse(t),r=o.streams.find(m=>m.codec_type==="video");if(!r)throw new Error("No video stream found");let i=30;if(r.r_frame_rate){let[m,c]=r.r_frame_rate.split("/").map(Number);i=c?m/c:m}let s=parseFloat(o.format?.duration||"0"),a=Math.ceil(i*s);return{width:r.width,height:r.height,fps:i,frames:a,duration:s}}async function k(e,t){return new Promise((o,r)=>{let i=F.join(t,"frame_%06d.png"),s=x("ffmpeg",["-i",e,"-vsync","0",i]);s.on("close",a=>{a===0?o():r(new Error(`FFmpeg exited with code ${a}`))}),s.on("error",r)})}async function I(e,t,o,r){return new Promise((i,s)=>{let a=F.join(e,"frame_%06d.png"),m;switch(r){case"webm":m=["-y","-framerate",o.toString(),"-i",a,"-c:v","libvpx-vp9","-pix_fmt","yuva420p","-auto-alt-ref","0","-b:v","2M","-crf","30",t];break;case"mov":m=["-y","-framerate",o.toString(),"-i",a,"-c:v","prores_ks","-profile:v","4444","-pix_fmt","yuva444p10le",t];break;case"gif":m=["-y","-framerate",o.toString(),"-i",a,"-filter_complex","[0:v] split [a][b];[a] palettegen=reserve_transparent=on:transparency_color=ffffff [p];[b][p] paletteuse",t];break}let c=x("ffmpeg",m);c.on("close",f=>{f===0?i():s(new Error(`FFmpeg exited with code ${f}`))}),c.on("error",s)})}var U=L(import.meta.url),X=n.dirname(U.resolve("@imgly/background-removal-node")),G=`file://${X}/`,J=new Set([".mp4",".mov",".webm",".avi",".mkv",".m4v",".ogv"]),W=new Set([".jpg",".jpeg",".png",".webp",".bmp",".tiff"]);function E(e){return J.has(n.extname(e).toLowerCase())}function j(e){return W.has(n.extname(e).toLowerCase())}function z(e){return p.statSync(e).isFile()?[e]:p.readdirSync(e).map(o=>n.join(e,o)).filter(o=>p.statSync(o).isFile()&&(E(o)||j(o)))}async function O(e,t){let o=`file://${e}`,i=await(await M(o,{publicPath:G})).arrayBuffer(),s=Buffer.from(i),a=t.replace(/\.[^.]+$/,".png");await T(s).png().toFile(a)}async function H(e,t){let o=n.basename(e,n.extname(e)),r=n.join(t,`${o}_cutout.png`),i=d(`Processing: ${n.basename(e)}`).start();try{await O(e,r),i.succeed(`Done: ${n.basename(r)}`)}catch(s){throw i.fail(`Failed: ${n.basename(e)}`),s}}async function K(e,t,o){let r=n.basename(e,n.extname(e)),i=o.format==="mov"?".mov":o.format==="gif"?".gif":".webm",s=n.join(t,`${r}_cutout${i}`);console.log(`
\u{1F4F9} Processing: ${n.basename(e)}`);let a=n.join(t,".tmp",r),m=n.join(a,"raw"),c=n.join(a,"transparent");p.mkdirSync(m,{recursive:!0}),p.mkdirSync(c,{recursive:!0});try{let f=await _(e);console.log(`   ${f.width}x${f.height}, ${f.fps.toFixed(2)}fps, ${f.frames} frames`);let N=d("Extracting frames...").start();await k(e,m),N.succeed("Frames extracted");let g=p.readdirSync(m).filter(u=>u.endsWith(".png")).sort(),w=d(`Removing backgrounds (0/${g.length})`).start();for(let u=0;u<g.length;u++){let y=g[u],R=n.join(m,y),A=n.join(c,y);await O(R,A),w.text=`Removing backgrounds (${u+1}/${g.length})`}w.succeed("Backgrounds removed");let P=d("Creating video...").start();await I(c,s,f.fps,o.format),P.succeed(`Created: ${n.basename(s)}`)}finally{p.rmSync(a,{recursive:!0,force:!0})}}async function q(e,t,o){let r=z(e);if(r.length===0)throw new Error(`No supported files found in: ${e}`);let i=r.filter(j),s=r.filter(E);console.log(`\u{1F4C1} Found: ${i.length} image(s), ${s.length} video(s)`);for(let a of i)await H(a,t);for(let a of s)await K(a,t,o)}import V from"path";import v from"fs";B.name("human-cutout").description("AI-powered background removal for images and videos").version("1.0.0").option("-i, --input <path>","Input file or directory","./input").option("-o, --output <path>","Output directory","./output").option("-f, --format <format>","Video output format (webm, mov, gif)","webm").option("-q, --quality <quality>","Output quality (low, medium, high)","medium").parse();var l=B.opts();async function Q(){console.log(`
\u{1F3AC} human-cutout - AI Background Removal
`),await S()||(console.error("\u274C FFmpeg is required but not found."),console.error("   Install: brew install ffmpeg (macOS) or apt install ffmpeg (Linux)"),process.exit(1));let t=V.resolve(l.input),o=V.resolve(l.output);v.existsSync(t)||(console.error(`\u274C Input not found: ${t}`),process.exit(1)),v.existsSync(o)||v.mkdirSync(o,{recursive:!0});let r=["webm","mov","gif"];r.includes(l.format)||(console.error(`\u274C Invalid format: ${l.format}`),console.error(`   Valid formats: ${r.join(", ")}`),process.exit(1));try{await q(t,o,{format:l.format,quality:l.quality}),console.log(`
\u2705 Done! Output: ${o}
`)}catch(i){console.error(`
\u274C Error:`,i),process.exit(1)}}Q();
